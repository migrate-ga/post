<!DOCTYPE html>
<html>
  <head>  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
  //window.ga = function () { console.log('ga(' + [].slice.apply(arguments).map(x => typeof x === 'string' || typeof x === "object" ? JSON.stringify(x) : `<${typeof x}>`).join(', ') + ')');};
  
  var startTime = new Date();
(function () {
  //window.ga = function() { gaEvQueue.push(arguments)};
  var loaded = 0;
  function initGA(clientId) {
    // ga has already been initialized
    if (loaded++) return;

    var opts;
    if (clientId !== undefined) {
      opts = {
        clientId: clientId,
      };
    }

    ga('create', 'UA-35608136-3', 'lmn-post.glitch.me', opts);
    ga('send', 'pageview');
    ga('send', 'event', 'debug', 'normal');
    
    ga(function (tracker) {
      console.log("tracker:", tracker);
      var loadTime = new Date() - startTime;
      document.getElementById('clientid').textContent = tracker.get('clientId') + ` (${loadTime} ms)`;
    });
    
    
  }
  
  // Wait max 2 sec for cookie migration.
  setTimeout(initGA, 2000);

  // Handle incoming GA cookie migration message from migration iframe
  window.addEventListener('message', function(event) {
    console.log("Got message:", event);
    // Ignores messages from untrusted domains.
    if (event.origin != 'https://lmn-pre.glitch.me') return;
    // only handle clientId migration in this handler
    if (event.data.type != 'ga-clientId') return;
    initGA(event.data.clientId);
  });
})();
  
  
  
  </script>
  
</head>
  
<body>

<!-- load cookie migration iframe -->
<iframe id=client-id-migration src=https://lmn-pre.glitch.me/ga-client-id.html style=display:none></iframe>

<!-- migration POC -->
<p>
  My GA client ID: <span id=clientid></span>
</p>
<script>
  ga(function (tracker) {
    console.log("tracker:", tracker);
    document.getElementById('clientid').textContent = tracker.get('clientId');
  });
</script>

  </body>
</html>
